name: Auto Merge Dev to Main (Daily)

on:
  schedule:
    - cron: '0 15 * * *' # 10:00 AM EST (15:00 UTC) daily
  workflow_dispatch:

jobs:
  merge-dev-to-main:
    name: Merge dev to main
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Check for changes and create/merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Check if dev is ahead of main
          COMPARISON=$(gh api "repos/${GH_REPO}/compare/main...dev" --jq '{ahead: .ahead_by, status: .status}')
          COMMITS_AHEAD=$(echo "$COMPARISON" | jq -r '.ahead')

          if [ "$COMMITS_AHEAD" -eq 0 ]; then
            echo "No changes in dev relative to main. Nothing to do."
            exit 0
          fi

          echo "Dev is $COMMITS_AHEAD commit(s) ahead of main."

          # Check for an existing open PR from dev -> main
          EXISTING_PR=$(gh pr list --base main --head dev --state open --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING_PR" ]; then
            echo "Existing PR #${EXISTING_PR} found. Enabling auto-merge."
            PR_NUMBER="$EXISTING_PR"
          else
            echo "Creating new PR..."
            PR_URL=$(gh pr create \
              --base main \
              --head dev \
              --title "Daily Auto-Merge: Dev to Main" \
              --body "$(cat <<EOF
          ## Automated Daily Merge

          This PR was automatically created to merge the latest changes from \`dev\` into \`main\`.

          **Changes**: ${COMMITS_AHEAD} commit(s)
          **Triggered**: $(date -u '+%Y-%m-%d %H:%M UTC')

          ### Pre-merge checklist
          - All CI checks must pass
          - No merge conflicts

          ---
          *This PR will auto-merge once all checks pass.*
          EOF
            )" \
              --label "auto-merge")

            PR_NUMBER=$(gh pr view "$PR_URL" --json number --jq '.number')
            echo "Created PR #${PR_NUMBER}."
          fi

          # Enable auto-merge (squash, keep dev branch)
          gh pr merge "$PR_NUMBER" --auto --squash
          echo "Auto-merge enabled for PR #${PR_NUMBER}."
